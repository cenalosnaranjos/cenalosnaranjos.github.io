<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bar Ceta - Sistema de Facturación de Ventas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* --- VARIABLES CSS ORIGINALES --- */
        :root {
            --primary-color: #ff6b35; /* Naranja/Coral de Bar Ceta */
            --secondary-color-light: #2d3047; /* Azul oscuro original */
            --accent-color-light: #f7c59f; /* Color de acento original */
            --light-color-light: #f8f9fa;
            --card-bg-light: #ffffff;
            --body-bg-light: #f5f5f5;
            --text-color-light: #212529;
            --shadow-light: 0 4px 6px rgba(0, 0, 0, 0.1);
            
            /* --- VARIABLES MODO OSCURO (PREDETERMINADO) --- */
            --secondary-color: #f7c59f; /* Azul oscuro a acento claro en dark */
            --accent-color: #495057; /* Gris medio para acentos en dark */
            --light-color: #495057; /* Gris medio para contenedores ligeros en dark */
            --card-bg: #343a40; /* Gris oscuro para cards en dark */
            --body-bg: #212529; /* Fondo muy oscuro en dark */
            --text-color: #f8f9fa; /* Texto claro en dark */
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.4); /* Sombra más oscura en dark */
            
            --success-color: #28a745;
            --error-color: #dc3545;
            --transition: all 0.3s ease;
            --radius: 12px;
        }

        /* Establecer Modo Oscuro como Default en el body */
        body {
            background-color: var(--body-bg);
            color: var(--text-color);
            line-height: 1.6;
            transition: var(--transition);
        }
        
        /* Definir el modo claro para el toggle */
        body.light-mode {
            background-color: var(--body-bg-light);
            color: var(--text-color-light);
            --card-bg: var(--card-bg-light);
            --body-bg: var(--body-bg-light);
            --text-color: var(--text-color-light);
            --secondary-color: var(--secondary-color-light);
            --accent-color: var(--accent-color-light);
            --light-color: var(--light-color-light);
            --shadow: var(--shadow-light);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: var(--transition);
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Estilos de Header */
        header {
            /* Usamos colores primarios fijos para el degradado */
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color-light)); 
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
        }
        
        /* Toggle Modo Oscuro */
        #dark-mode-toggle {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            outline: none;
        }

        .logo {
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .content-card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            border-top: 5px solid var(--primary-color);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            /* Usamos el secondary-color que cambia según el modo */
            color: var(--secondary-color); 
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-weight: 500;
        }

        /* Estilos de inputs y selectores (adaptados para modo oscuro por defecto) */
        .form-control, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            /* El borde y fondo son para el modo oscuro por defecto */
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: var(--radius);
            background-color: var(--light-color);
            color: var(--text-color);
            font-size: 1rem;
            transition: var(--transition);
        }
        
        /* Ajuste de inputs para modo claro si se alterna */
        body.light-mode .form-control, body.light-mode .form-select {
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.3);
        }

        /* Botones */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e55c2d;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--error-color);
            color: white;
            padding: 0.5rem 1rem;
        }

        /* Tabla de Ventas */
        .sales-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }

        .sales-table th, .sales-table td {
            text-align: left;
            padding: 0.75rem;
            /* Borde para modo oscuro por defecto */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
        }
        
        /* Borde para modo claro si se alterna */
        body.light-mode .sales-table th, body.light-mode .sales-table td {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .sales-table th {
            background-color: var(--accent-color);
            color: var(--text-color);
            font-weight: 600;
        }
        
        .input-cantidad {
            width: 70px;
            padding: 0.5rem;
            text-align: center;
            border-radius: 5px;
        }

        .total-summary {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: var(--light-color);
            border-radius: var(--radius);
            /* Borde para modo oscuro por defecto */
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        
        /* Borde para modo claro si se alterna */
        body.light-mode .total-summary {
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            font-size: 1.125rem;
            padding: 0.5rem 0;
        }
        
        .total-row.grand-total {
            font-size: 1.5rem;
            /* Borde para modo oscuro por defecto */
            border-top: 2px dashed rgba(255, 255, 255, 0.3); 
            margin-top: 1rem;
            padding-top: 1rem;
            color: var(--text-color);
        }
        
        /* Borde para modo claro si se alterna */
        body.light-mode .total-row.grand-total {
            border-top: 2px dashed rgba(0, 0, 0, 0.2);
            color: var(--secondary-color);
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: flex-end;
        }
        
        /* --- Estilos de Factura PDF (NO deben cambiar con el modo oscuro) --- */
        #invoice-container {
            padding: 25px;
            margin-top: 20px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 12px;
            width: 100%;
            display: none; 
            color: #212529; 
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #ff6b35; 
        }
        
        .invoice-title {
            font-size: 20px;
            font-weight: 700;
            color: #2d3047; 
        }
        
        .invoice-client-info {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            background-color: #f8f9fa; 
        }
        
        .invoice-client-info h4 {
            font-size: 14px;
            margin-bottom: 5px;
            color: #ff6b35; 
        }
        
        #invoice-detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        #invoice-detail-table th, #invoice-detail-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 11px;
        }
        
        #invoice-detail-table th {
            background-color: #2d3047;
            color: white;
        }
        
        .invoice-totals {
            float: right;
            width: 50%;
        }
        
        .invoice-totals table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .invoice-totals tr:last-child td {
            font-weight: 700;
            border-top: 2px solid #ff6b35;
            font-size: 14px;
            color: #ff6b35; 
        }
    </style>
</head>
<body class="dark-mode"> 

    <header>
        <div class="container">
            <div class="logo">
                <i class="fas fa-receipt"></i>
                <span>Bar Ceta - Sistema de Facturación</span>
            </div>
        </div>
        <button id="dark-mode-toggle" title="Alternar Modo Oscuro/Claro">
            <i class="fas fa-sun"></i> 
        </button>
    </header>

    <main class="container">
        
        <div class="content-card">
            <h2 class="section-title"><i class="fas fa-user-tag"></i> Datos del Estudiante/Cliente</h2>
            <form id="student-form">
                <div class="form-group">
                    <label for="student-name">Nombre Completo *</label>
                    <input type="text" id="student-name" class="form-control" required placeholder="Nombre Completo del Estudiante">
                </div>
                <div class="form-group">
                    <label for="payment-type">Forma de Pago *</label>
                    <select id="payment-type" class="form-select" required>
                        <option value="Contado" selected>Contado (Pagado)</option>
                        <option value="Fiado">Fiado (Pendiente)</option>
                    </select>
                </div>
                </form>
        </div>

        <div class="content-card">
            <h2 class="section-title"><i class="fas fa-hotdog"></i> Detalle de Venta (Bar Ceta)</h2>
            
            <div class="action-buttons" style="justify-content: flex-start; margin-top: 0;">
                <button type="button" class="btn btn-primary" id="add-row-btn">
                    <i class="fas fa-plus-circle"></i> Añadir Producto
                </button>
            </div>

            <table class="sales-table">
                <thead>
                    <tr>
                        <th style="width: 50%;">Producto</th>
                        <th style="width: 15%; text-align: center;">Cantidad</th>
                        <th style="width: 15%; text-align: right;">P. Unitario</th>
                        <th style="width: 10%; text-align: right;">Total</th>
                        <th style="width: 10%; text-align: center;">Acción</th>
                    </tr>
                </thead>
                <tbody id="sales-detail-body">
                    </tbody>
            </table>
            
            <datalist id="product-options">
                </datalist>

            <div class="total-summary">
                <div class="total-row grand-total">
                    <span>TOTAL A PAGAR:</span>
                    <strong id="grand-total-val">$0.00</strong>
                </div>
            </div>

            <div class="action-buttons">
                <button type="button" class="btn btn-success" id="generate-pdf-btn">
                    <i class="fas fa-file-pdf"></i> Generar Factura PDF
                </button>
            </div>
        </div>
        
        <div id="invoice-container">
            <div class="invoice-header">
                <div class="invoice-title">FACTURA DE VENTA - Bar Ceta</div>
                <div class="invoice-info" id="invoice-info-data">
                    <p><strong>Fecha:</strong> <span id="invoice-date"></span></p>
                    <p><strong>Hora:</strong> <span id="invoice-time"></span></p>
                    <p><strong>Factura N°:</strong> <span id="invoice-number"></span></p>
                </div>
            </div>
            
            <div class="invoice-client-info">
                <h4>Datos del Estudiante/Cliente</h4>
                <p><strong>Nombre:</strong> <span id="pdf-student-name"></span></p>
                <p><strong>Forma de Pago:</strong> <span id="pdf-payment-type"></span></p>
                </div>
            
            <table id="invoice-detail-table">
                <thead>
                    <tr>
                        <th style="width: 50%;">Descripción</th>
                        <th style="width: 15%; text-align: center;">Cant.</th>
                        <th style="width: 15%; text-align: right;">P. Unitario ($)</th>
                        <th style="width: 20%; text-align: right;">Total ($)</th>
                    </tr>
                </thead>
                <tbody id="pdf-sales-detail-body">
                    </tbody>
            </table>
            
            <div class="invoice-totals">
                <table>
                    <tr id="pdf-grand-total-row">
                        <td>TOTAL A PAGAR:</td>
                        <td>$0.00</td>
                    </tr>
                </table>
            </div>
            <div style="clear: both;"></div>
            <p style="text-align: center; margin-top: 30px; border-top: 1px dashed #ccc; padding-top: 10px; font-size: 10px;">Gracias por su compra. Documento no válido como factura tributaria.</p>
        </div>
        </main>

    <script>
        // --- 1. DATOS DE PRODUCTOS ---
        const products = [
            { id: 1, name: "Pipas ácidas", price: 0.25, category: "Pipas" },
            { id: 2, name: "Pipas naturales", price: 0.25, category: "Pipas" },
            { id: 3, name: "Pipas de mango biche", price: 0.25, category: "Pipas" },
            { id: 4, name: "Pipas de maracuyá", price: 0.25, category: "Pipas" },
            { id: 5, name: "Golpe de queso", price: 0.30, category: "Snacks Salados" },
            { id: 6, name: "Golpe de limón", price: 0.30, category: "Snacks Salados" },
            { id: 7, name: "Papas de mayonesa", price: 0.30, category: "Snacks Salados" },
            { id: 8, name: "Papas naturakes", price: 0.30, category: "Snacks Salados" },
            { id: 9, name: "Papas de limón", price: 0.30, category: "Snacks Salados" },
            { id: 10, name: "Chis Trix", price: 0.30, category: "Snacks Salados" },
            { id: 11, name: "Quipitos", price: 0.30, category: "Snacks Salados" },
            { id: 12, name: "Chifles", price: 0.30, category: "Snacks Salados" },
            { id: 13, name: "Maduritos", price: 0.30, category: "Snacks Salados" },
            { id: 14, name: "Paletas ácidas", price: 0.25, category: "Dulces y Golosinas" },
            { id: 15, name: "Mini paletas ácidas", price: 0.10, category: "Dulces y Golosinas" },
            { id: 16, name: "Chicles Bubbaloo", price: 0.10, category: "Dulces y Golosinas" },
            { id: 17, name: "Paquetes de gomitas", price: 0.30, category: "Dulces y Golosinas" },
            { id: 18, name: "Fundita de gomitas", price: 0.50, category: "Dulces y Golosinas" },
            { id: 19, name: "Coca Cola", price: 0.60, category: "Bebidas" },
            { id: 20, name: "Pepsi", price: 0.30, category: "Bebidas" },
            { id: 21, name: "Big Cola", price: 0.30, category: "Bebidas" }
        ];
        
        // --- FUNCIONES AUXILIARES ---
        
        // Obtiene el objeto producto por el nombre formateado (ej: "Pipas ácidas ($0.25)")
        function getProductByName(productName) {
            // El formato es "Nombre del Producto ($0.00)"
            const nameOnly = productName.substring(0, productName.lastIndexOf('($')).trim();
            return products.find(p => p.name === nameOnly);
        }
        
        // Formatea el nombre del producto para mostrar en el datalist
        function getFormattedProductName(product) {
            return `${product.name} ($${product.price.toFixed(2)})`;
        }

        // --- 2. ELEMENTOS DEL DOM y ESTADO ---
        const salesDetailBody = document.getElementById('sales-detail-body');
        const addRowBtn = document.getElementById('add-row-btn');
        const generatePdfBtn = document.getElementById('generate-pdf-btn');
        const productOptionsDatalist = document.getElementById('product-options');
        
        const grandTotalVal = document.getElementById('grand-total-val');
        
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        
        let rowCounter = 0;
        
        // --- LÓGICA DE MODO OSCURO PREDETERMINADO ---
        function toggleDarkMode() {
            // Alterna entre el modo oscuro (default) y light-mode (clase opuesta)
            const isLightMode = document.body.classList.toggle('light-mode');
            
            if (isLightMode) {
                // Estamos en modo claro -> cambiar a icono Luna para volver a oscuro
                darkModeToggle.querySelector('i').className = 'fas fa-moon'; 
                localStorage.setItem('darkMode', 'disabled');
            } else { 
                // Estamos en modo oscuro -> cambiar a icono Sol para volver a claro
                darkModeToggle.querySelector('i').className = 'fas fa-sun'; 
                localStorage.setItem('darkMode', 'enabled');
            }
        }
        
        // --- FUNCIÓN PARA LLENAR EL DATALIST (LA LISTA DE BÚSQUEDA) ---
        function populateDatalist() {
            productOptionsDatalist.innerHTML = '';
            products.forEach(product => {
                const option = document.createElement('option');
                // El valor es el texto completo que se buscará y seleccionará
                option.value = getFormattedProductName(product);
                productOptionsDatalist.appendChild(option);
            });
        }


        // --- 3. LÓGICA DE DETALLE DE VENTA ---

        // Función para añadir una nueva fila de producto
        function addRow() {
            rowCounter++;
            const newRow = salesDetailBody.insertRow();
            newRow.id = `row-${rowCounter}`;
            
            // Columna 1: Producto (Input con Datalist para búsqueda)
            const cellProduct = newRow.insertCell();
            const productInput = document.createElement('input');
            productInput.type = 'text';
            productInput.setAttribute('list', 'product-options'); // Asociar con la datalist
            productInput.className = 'form-control product-search-input product-input';
            productInput.name = 'product';
            productInput.placeholder = 'Buscar o seleccionar producto...';
            productInput.required = true;
            // Usamos 'change' para asegurar que el precio se actualice solo al seleccionar un valor de la lista
            productInput.addEventListener('change', updateRowTotals); 
            cellProduct.appendChild(productInput);
            
            // Columna 2: Cantidad (Input)
            const cellQuantity = newRow.insertCell();
            cellQuantity.style.textAlign = 'center';
            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.min = '1';
            quantityInput.value = '1';
            quantityInput.className = 'form-control input-cantidad quantity-input';
            quantityInput.addEventListener('input', updateRowTotals);
            cellQuantity.appendChild(quantityInput);
            
            // Columna 3: P. Unitario (Display)
            const cellPrice = newRow.insertCell();
            cellPrice.classList.add('unit-price');
            cellPrice.style.textAlign = 'right';
            cellPrice.textContent = '$0.00';
            
            // Columna 4: Subtotal (Display) - Ahora solo "Total"
            const cellSubtotal = newRow.insertCell();
            cellSubtotal.classList.add('row-subtotal');
            cellSubtotal.style.textAlign = 'right';
            cellSubtotal.textContent = '$0.00';
            
            // Columna 5: Acción (Botón Eliminar)
            const cellAction = newRow.insertCell();
            cellAction.style.textAlign = 'center';
            const deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'btn btn-danger btn-sm';
            deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
            deleteButton.onclick = () => {
                newRow.remove();
                calculateTotal();
            };
            cellAction.appendChild(deleteButton);
            
            // Aseguramos que se actualicen los totales
            newRow.querySelector('.quantity-input').oninput = updateRowTotals;

            calculateTotal(); 
        }
        
        // Función para actualizar los totales de una fila
        function updateRowTotals(event) {
            const row = event.target.closest('tr');
            const productInput = row.querySelector('.product-input');
            const quantityInput = row.querySelector('.quantity-input');
            const unitPriceCell = row.querySelector('.unit-price');
            const rowSubtotalCell = row.querySelector('.row-subtotal');
            
            const productName = productInput.value;
            const product = getProductByName(productName); 
            
            let price = 0;
            if (product) {
                price = product.price;
            }
            
            const quantity = parseInt(quantityInput.value) || 0;
            
            // Validación simple de cantidad
            let actualQuantity = quantity;
            if (actualQuantity < 1 || isNaN(actualQuantity)) {
                actualQuantity = 1;
                quantityInput.value = 1;
            }
            
            const totalRowPrice = price * actualQuantity; 
            unitPriceCell.textContent = `$${price.toFixed(2)}`;
            rowSubtotalCell.textContent = `$${totalRowPrice.toFixed(2)}`;
            
            calculateTotal();
        }
        
        // Función para calcular el total de la venta
        function calculateTotal() {
            let grandTotal = 0; 
            const rows = salesDetailBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const rowSubtotalCell = row.querySelector('.row-subtotal');
                const subtotalText = rowSubtotalCell.textContent.replace('$', '');
                grandTotal += parseFloat(subtotalText) || 0;
            });
            
            grandTotalVal.textContent = `$${grandTotal.toFixed(2)}`;
        }

        // --- 4. LÓGICA DE GENERACIÓN DE PDF (Factura) ---
        async function generatePDF() {
            // Validación de campos obligatorios
            const studentName = document.getElementById('student-name').value.trim();
            const paymentType = document.getElementById('payment-type').value; 
            
            if (studentName === '') {
                alert('ERROR: Por favor, complete el Nombre Completo del Estudiante/Cliente.');
                return;
            }
            
            if (salesDetailBody.children.length === 0) {
                alert('ERROR: Debe añadir al menos un producto a la venta.');
                return;
            }
            
            // Validación de que todos los productos seleccionados son válidos de la lista
            const rows = salesDetailBody.querySelectorAll('tr');
            let allProductsValid = true;
            rows.forEach(row => {
                const productInput = row.querySelector('.product-input');
                const product = getProductByName(productInput.value);
                // Si el valor del input no corresponde a un producto en el array (por nombre formateado)
                if (!product) { 
                    allProductsValid = false;
                }
            });
            
            if (!allProductsValid) {
                 alert('ERROR: Uno o más productos seleccionados no son válidos. Por favor, asegúrese de seleccionar un producto de la lista sugerida (datalist) usando el buscador.');
                 return;
            }
            
            // 1. Preparar el contenedor oculto con los datos
            const now = new Date();
            const invoiceDate = now.toLocaleDateString('es-EC');
            const invoiceTime = now.toLocaleTimeString('es-EC', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const invoiceNumber = Date.now().toString().slice(-8); 

            document.getElementById('invoice-date').textContent = invoiceDate;
            document.getElementById('invoice-time').textContent = invoiceTime;
            document.getElementById('invoice-number').textContent = invoiceNumber;
            
            document.getElementById('pdf-student-name').textContent = studentName;
            document.getElementById('pdf-payment-type').textContent = paymentType; 
            
            // Llenar tabla de detalles para el PDF
            const pdfDetailBody = document.getElementById('pdf-sales-detail-body');
            pdfDetailBody.innerHTML = '';
            
            let pdfGrandTotal = 0;
            
            rows.forEach(row => {
                const productInput = row.querySelector('.product-input');
                const quantityInput = row.querySelector('.quantity-input');
                const unitPriceCell = row.querySelector('.unit-price');
                const rowSubtotalCell = row.querySelector('.row-subtotal');
                
                // El valor del input ya es el nombre formateado
                const productName = productInput.value; 

                const quantity = parseInt(quantityInput.value) || 0;
                const unitPrice = parseFloat(unitPriceCell.textContent.replace('$', '')) || 0;
                const totalRowPrice = parseFloat(rowSubtotalCell.textContent.replace('$', '')) || 0;
                
                pdfGrandTotal += totalRowPrice;

                const pdfRow = pdfDetailBody.insertRow();
                pdfRow.innerHTML = `
                    <td>${productName}</td>
                    <td style="text-align: center;">${quantity}</td>
                    <td style="text-align: right;">${unitPrice.toFixed(2)}</td>
                    <td style="text-align: right;">${totalRowPrice.toFixed(2)}</td>
                `;
            });
            
            // Llenar totales para el PDF
            document.getElementById('pdf-grand-total-row').innerHTML = `<td>TOTAL A PAGAR:</td><td>$${pdfGrandTotal.toFixed(2)}</td>`;
            
            // 2. Mostrar contenedor oculto para la captura
            const invoiceContainer = document.getElementById('invoice-container');
            invoiceContainer.style.display = 'block';

            // 3. Capturar el HTML y generar el PDF
            try {
                const canvas = await html2canvas(invoiceContainer, { 
                    scale: 3, 
                    useCORS: true 
                });
                
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 180; 
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 10; 

                pdf.addImage(imgData, 'JPEG', 15, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 15, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // Usamos el nombre y una porción del número de factura para el nombre del archivo
                const safeStudentName = studentName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                pdf.save(`Factura_BarCeta_${safeStudentName}_${invoiceNumber}.pdf`);

            } catch (error) {
                console.error("Error al generar el PDF:", error);
                alert('Ocurrió un error al generar el PDF. Revisa la consola para más detalles.');
            }
            
            // 4. Ocultar el contenedor nuevamente
            invoiceContainer.style.display = 'none';
        }

        // --- 5. INICIALIZACIÓN Y EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Llenar la lista de opciones para el buscador (datalist)
            populateDatalist();
            
            // 2. Lógica del Modo Oscuro al Cargar
            const storedDarkMode = localStorage.getItem('darkMode');
            
            // Si el modo almacenado es 'disabled', forzamos el modo claro, sino se mantiene el default (dark-mode)
            if (storedDarkMode === 'disabled') {
                document.body.classList.add('light-mode'); 
                darkModeToggle.querySelector('i').className = 'fas fa-moon';
            } else {
                // Si no hay nada en storage o es 'enabled', se asume dark-mode (default CSS)
                localStorage.setItem('darkMode', 'enabled');
            }
            
            // 3. Configurar eventos
            darkModeToggle.addEventListener('click', toggleDarkMode);
            addRow(); // Añadir la primera fila al cargar
            addRowBtn.addEventListener('click', addRow);
            generatePdfBtn.addEventListener('click', generatePDF);
        });
    </script>
</body>
</html>